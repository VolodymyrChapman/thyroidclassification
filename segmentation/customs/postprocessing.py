from skimage.color import label2rgb
from skimage.segmentation import watershed
import numpy as np
from skimage import measure


def adapted_border_postprocessing(border_prediction, cell_prediction):
    """

    :param border_prediction:
    :param cell_prediction:
    :return:
    """

    prediction_border_bin = np.argmax(border_prediction, axis=-1)
    cell_prediction = cell_prediction > 0.5
    seeds = border_prediction[:, :, 1] * (1 - border_prediction[:, :, 2]) > 0.5  # Substract borders from cell seed
    seeds = measure.label(seeds, background=0)

    prediction_instance = watershed(image=cell_prediction,
                                    markers=seeds,
                                    mask=cell_prediction,
                                    watershed_line=False,
                                    )
    prediction_instance = measure.label(prediction_instance, background=0)
    colors = get_colors()
    prediction_instance_rgb = label2rgb(prediction_instance, colors=colors, kind='overlay', bg_label=0)

    prediction_instance = np.expand_dims(prediction_instance, axis=-1)
    prediction_border_bin = np.expand_dims(prediction_border_bin, axis=-1)

    return prediction_instance.astype(np.uint16), prediction_instance_rgb.astype(np.uint8), prediction_border_bin.astype(np.uint8)


def get_colors():
    """ Get colors for color-coded instance segmentation.

    :return: colors.
    """

    colors = [[0, 0, 0], [57, 197, 211], [200, 251, 164], [207, 74, 33], [174, 26, 193], [142, 204, 200],
              [234, 45, 130], [123, 155, 24], [221, 134, 203], [171, 130, 255], [187, 245, 84], [134, 192, 129],
              [97, 190, 208], [74, 43, 188], [149, 106, 59], [54, 184, 127], [254, 215, 30], [64, 127, 122],
              [91, 121, 81], [254, 108, 104], [53, 161, 134], [195, 49, 200], [182, 137, 239], [85, 167, 64],
              [31, 27, 232], [103, 222, 147], [149, 154, 60], [214, 19, 210], [145, 38, 248], [37, 7, 134],
              [96, 30, 107], [66, 120, 74], [173, 220, 255], [252, 199, 112], [88, 242, 116], [79, 77, 182],
              [86, 161, 74], [74, 166, 116], [204, 73, 64], [83, 20, 135], [132, 112, 255], [232, 201, 85],
              [200, 213, 154], [151, 93, 194], [51, 239, 119], [85, 115, 76], [230, 211, 202], [11, 87, 137],
              [127, 164, 131], [13, 35, 246], [15, 249, 184], [143, 80, 152], [65, 102, 160], [159, 77, 68],
              [189, 61, 70], [160, 184, 186], [109, 170, 88], [146, 187, 231], [169, 176, 165], [72, 112, 203],
              [54, 184, 127], [5, 5, 219], [10, 199, 133], [74, 23, 61], [177, 249, 136], [83, 102, 65], [225, 53, 78],
              [254, 165, 10], [51, 98, 154], [86, 172, 156], [89, 173, 220], [58, 219, 164], [13, 245, 69],
              [181, 10, 214], [219, 103, 131], [205, 175, 199], [139, 245, 112], [16, 156, 59], [60, 149, 56],
              [186, 74, 89], [7, 49, 242], [104, 17, 120], [87, 233, 246], [99, 135, 27], [47, 200, 254],
              [240, 240, 150], [61, 96, 71], [189, 145, 95], [39, 22, 127], [90, 246, 16], [19, 206, 124],
              [227, 92, 157], [152, 238, 28], [150, 212, 49], [40, 5, 95], [74, 129, 112], [205, 14, 205],
              [24, 39, 165], [15, 144, 24], [75, 110, 175], [131, 96, 242], [128, 44, 92], [171, 208, 69],
              [78, 94, 156], [95, 219, 69], [109, 163, 102], [155, 110, 161], [20, 86, 116], [89, 250, 213],
              [191, 121, 91], [0, 206, 117], [250, 43, 88], [241, 202, 117], [249, 78, 40], [177, 18, 21],
              [170, 94, 181], [122, 65, 76], [9, 245, 39], [5, 102, 26], [184, 255, 63], [172, 218, 25], [227, 60, 179],
              [114, 126, 94], [104, 43, 123], [252, 178, 42], [78, 202, 160], [46, 21, 185], [203, 32, 76],
              [120, 253, 71], [252, 234, 103], [164, 87, 117], [122, 211, 43], [238, 19, 97], [144, 198, 251],
              [79, 99, 25], [221, 20, 168], [47, 198, 13], [117, 129, 143], [157, 160, 101], [13, 59, 207],
              [5, 161, 39], [20, 169, 158], [254, 50, 87], [126, 21, 240], [99, 141, 161], [175, 190, 50],
              [183, 187, 22], [27, 216, 72], [161, 205, 84],  [226, 210, 190], [79, 215, 51], [255, 24, 36],
              [83, 65, 45], [61, 200, 252], [124, 67, 216], [211, 98, 126], [81, 200, 131], [43, 126, 103],
              [9, 116, 224], [66, 163, 155], [96, 26, 100], [223, 67, 89], [26, 200, 109], [20, 205, 141],
              [47, 25, 25], [243, 49, 65], [64, 161, 136], [19, 122, 148], [142, 168, 38], [13, 131, 147],
              [12, 224, 98], [147, 112, 24], [22, 234, 110], [33, 212, 54], [215, 254, 170], [199, 76, 121],
              [18, 254, 146], [87, 207, 125], [7, 19, 196], [201, 185, 145],  [216, 59, 124], [147, 239, 44],
              [249, 35, 203], [28, 237, 193], [211, 199, 201], [131, 8, 21], [67, 47, 53], [44, 231, 156],
              [118, 173, 83], [159, 33, 252], [180, 127, 22], [115, 71, 92], [223, 200, 204], [74, 25, 215],
              [165, 157, 82], [92, 2, 93], [25, 243, 245], [128, 89, 80], [66, 96, 126], [35, 75, 158], [117, 78, 24],
              [195, 178, 131], [183, 211, 240], [102, 219, 96], [127, 125, 253], [64, 57, 185], [236, 253, 149],
              [199, 232, 216], [134, 122, 211], [156, 55, 185], [46, 194, 109], [95, 127, 147], [6, 73, 73],
              [86, 72, 179], [208, 50, 75], [97, 24, 128], [74, 89, 222], [27, 201, 58], [182, 218, 11],
              [161, 151, 100], [171, 30, 93], [125, 92, 130], [62, 19, 150], [37, 19, 124], [3, 8, 188],
              [118, 231, 102], [189, 9, 42], [20, 135, 195], [102, 130, 179], [86, 33, 216], [242, 100, 132],
              [155, 229, 84], [101, 24, 179], [144, 54, 168], [78, 131, 16], [207, 203, 231], [165, 119, 146],
              [68, 38, 66], [32, 254, 213], [20, 102, 14], [214, 59, 78], [47, 66, 236], [123, 22, 174],
              [230, 139, 219], [100, 68, 117], [233, 212, 222], [205, 64, 170], [24, 243, 47], [137, 170, 44],
              [137, 111, 30], [0, 91, 219], [200, 47, 18], [209, 189, 232], [171, 77, 143], [146, 105, 198],
              [255, 255, 255], [196, 133, 119], [104, 116, 142], [79, 159, 201], [75, 172, 251], [29, 238, 129],
              [121, 35, 49], [252, 135, 105], [9, 188, 29], [217, 254, 21], [20, 233, 42], [48, 151, 13],
              [167, 193, 228], [88, 197, 42], [216, 150, 247], [117, 2, 223], [213, 168, 223], [175, 162, 129],
              [22, 40, 159], [109, 152, 63], [226, 142, 129], [91, 132, 106], [42, 201, 181], [120, 246, 54],
              [27, 99, 71], [127, 18, 209], [141, 25, 110], [92, 230, 195], [253, 47, 181], [32, 211, 64],
              [159, 242, 112], [10, 192, 235], [74, 228, 92], [30, 75, 243], [15, 244, 116], [99, 91, 77],
              [124, 162, 64], [60, 0, 142], [26, 108, 78], [20, 0, 235], [125, 13, 42], [242, 44, 251],
              [249, 121, 70], [102, 10, 105], [111, 138, 51], [135, 134, 193], [168, 241, 144], [208, 207, 243],
              [223, 29, 37], [255, 234, 120], [78, 27, 171], [237, 31, 141], [114, 43, 152], [26, 126, 41],
              [11, 163, 207]
        ]

    return colors